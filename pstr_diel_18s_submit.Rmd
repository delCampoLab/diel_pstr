---
title: "16s_curacao"
author: "Brad Weiler"
date: "2023-10-04"
---


#Load in required programs for the pipeline 
```{r, warning=FALSE}
library("devtools"); packageVersion("devtools")
library("phyloseq"); packageVersion("phyloseq")
library("dada2"); packageVersion("dada2")
library("Biostrings"); packageVersion("Biostrings")
library("ggplot2"); packageVersion("ggplot2")
library("ALDEx2");packageVersion("ALDEx2")
library("vegan"); packageVersion("vegan")
library("viridis"); packageVersion("viridis")
library("tidyr"); packageVersion("tidyr")
library("dplyr"); packageVersion("dplyr")
library("scales"); packageVersion("scales")
library("grid"); packageVersion("grid")
library("reshape2"); packageVersion("reshape2")
library("edgeR"); packageVersion("edgeR")
library("plyr"); packageVersion("plyr")
library("DESeq2"); packageVersion("DESeq2")
library("gridExtra"); packageVersion("gridExtra")
library("ampvis2"); packageVersion("ampvis2")
library("phangorn"); packageVersion("phangorn")
library("msa"); packageVersion("msa")
library("ape"); packageVersion("ape")
library("Rcpp"); packageVersion("Rcpp")
library("DECIPHER"); packageVersion("DECIPHER")
library("ggpubr"); packageVersion("ggpubr")
library("knitr"); packageVersion("knitr")
library("RColorBrewer"); packageVersion("RColorBrewer")
library("microbiome"); packageVersion("microbiome")
library("ggjoy"); packageVersion("ggjoy")
library("ggstance"); packageVersion("ggstance")
library("ggridges"); packageVersion("ggridges")
library("ggtree"); packageVersion("ggtree")
library("QsRutils"); packageVersion("QsRutils")
library("phytools"); packageVersion("phytools")
library("nlme"); packageVersion("nlme")
library("tidyverse"); packageVersion("tidyverse")
library("compositions"); packageVersion("compositions")
library("ANCOMBC"); packageVersion("ANCOMBC")
library("DT"); packageVersion("DT")
library("tibble"); packageVersion("tibble")
library("caret"); packageVersion("caret")
library("htmlwidgets"); packageVersion("htmlwidgets")
library("circlize"); packageVersion("circlize")
library("webshot"); packageVersion("webshot")
library("microeco"); packageVersion("microeco")
library("file2meco"); packageVersion("file2meco")
library("rgexf"); packageVersion("rgexf")
library("igraph"); packageVersion("igraph")
library("NetCoMi"); packageVersion("NetCoMi")
library("RColorBrewer")
library("LaCroixColoR")
library("decontam")
library("ggplot2")
library("phyloseq")
library("shadowtext")
library("ggtree")
library("ggtreeExtra")
library("treeio")
library("tidytree")
library("see")
library("gghalves")

```


##################################################################################
##                          Build Phyloseq/Filter                               ##
##################################################################################
#Build Phyloseq Object
```{r}
library(phyloseq); packageVersion("phyloseq")
SV <- read.table("/path/to/data/curacao/metabarcoding/data/exported_files/18s_expfiles_diel/ASVs_counts.tsv", row.names = 1, check.names= FALSE, sep = "\t", header = TRUE)
tax <-as.matrix(read.table("/path/to/data/curacao/metabarcoding/data/exported_files/18s_expfiles_diel/ASVs_taxonomy.tsv", row.names = 1, header = TRUE, sep = "\t", fill=TRUE))
map <- read.delim("/path/to/data/curacao/metabarcoding/data/curacao_mapping.txt", sep ="\t", header = TRUE, row.names = 1)
#library(read.table)
#tree <- ape::read.tree(file = "/path/to/data/curacao/metabarcoding/data/trees/18s_diel_tree.nw")

library(dplyr)
map <- filter(map, project=='Diel') %>% .[,colSums(is.na(map))<nrow(map)]

#Without a tree
ps = phyloseq(otu_table(SV, taxa_are_rows=TRUE), 
               sample_data(map), 

```

#Filter phyloseq object
```{r}
ps_diel_filtered <- subset_taxa(ps, (Domain!="Bacteria"| is.na(Domain)))
ps_diel_filtered <- subset_taxa(ps_diel_filtered, (Subdivision!="Metazoa"| is.na(Subdivision)))

f1<- filterfun_sample(topf(0.99))
wh1 <- genefilter_sample(ps_diel_filtered, f1, A=2)
ps_diel_filtered <- prune_taxa(wh1, ps_diel_filtered)

ps_diel_filtered <- prune_samples(sample_sums(ps_diel_filtered)>=250, ps_diel_filtered)
ps_diel_filtered

```

#Clean up the taxonomic table
```{r}
library(stringr)
tax.clean <- ps_diel_filtered@tax_table

tax.clean <- data.frame(row.names = row.names(ps_diel_filtered@tax_table),
Domain = str_replace(ps_diel_filtered@tax_table[,1], "D_0__",""),
Supergroup = str_replace(ps_diel_filtered@tax_table[,2], "D_1__",""),
Division = str_replace(ps_diel_filtered@tax_table[,3], "D_2__",""),
Subdivision = str_replace(ps_diel_filtered@tax_table[,4], "D_3__",""),
Class = str_replace(ps_diel_filtered@tax_table[,5], "D_4__",""),
Order = str_replace(ps_diel_filtered@tax_table[,6], "D_5__",""),
Family = str_replace(ps_diel_filtered@tax_table[,7], "D_6__",""),
Genus = str_replace(ps_diel_filtered@tax_table[,8], "D_7__",""),
Species = str_replace(ps_diel_filtered@tax_table[,9], "D_8__",""),
stringsAsFactors = FALSE)
tax.clean[is.na(tax.clean)] <- ""

for (i in 1:9){ tax.clean[,i] <- as.character(tax.clean[,i])}
####### Fille holes in the tax table
tax.clean[is.na(tax.clean)] <- ""
for (i in 1:nrow(tax.clean)){
  
  if (tax.clean[i,2] == ""){domain <- paste(tax.clean[i,1],"_X", sep = "")
  tax.clean[i, 2] <- domain
  tax.clean[i, 3] <- paste(domain,"X", sep = "")
  tax.clean[i, 4] <- paste(domain,"XX", sep = "")
  tax.clean[i, 5] <- paste(domain,"XXX", sep = "")
  tax.clean[i, 6] <- paste(domain,"XXXX", sep = "")
  tax.clean[i, 7] <- paste(domain,"XXXXX", sep = "")
  tax.clean[i, 8] <- paste(domain,"XXXXXX", sep = "")
  tax.clean[i, 9] <- paste(domain,"XXXXXX_sp.", sep = "")
} else 
  if (tax.clean[i,3] == ""){supergroup <- paste(tax.clean[i,2], "_X", sep = "")
  tax.clean[i, 3] <- supergroup
  tax.clean[i, 4] <- paste(supergroup,"X", sep = "")
  tax.clean[i, 5] <- paste(supergroup,"XX", sep = "")
  tax.clean[i, 6] <- paste(supergroup,"XXX", sep = "")
  tax.clean[i, 7] <- paste(supergroup,"XXXX.", sep = "")
  tax.clean[i, 8] <- paste(supergroup,"XXXXX", sep = "")
  tax.clean[i, 9] <- paste(supergroup,"XXXXX_sp.", sep = "")
} else 
  if (tax.clean[i,4] == ""){division <- paste(tax.clean[i,3], "_X", sep = "")
  tax.clean[i, 4] <- division
  tax.clean[i, 5] <- paste(division,"X", sep = "")
  tax.clean[i, 6] <- paste(division,"XX", sep = "")
  tax.clean[i, 7] <- paste(division,"XXX", sep = "")
  tax.clean[i, 8] <- paste(division,"XXXX", sep = "")
  tax.clean[i, 9] <- paste(division,"XXXX_sp.", sep = "")
} else 
  if (tax.clean[i,5] == ""){subdivision <- paste(tax.clean[i,4], "_X", sep = "")
  tax.clean[i, 5] <- subdivision
  tax.clean[i, 6] <- paste(subdivision,"X", sep = "")
  tax.clean[i, 7] <- paste(subdivision,"XX", sep = "")
  tax.clean[i, 8] <- paste(subdivision,"XXX", sep = "")
  tax.clean[i, 9] <- paste(subdivision,"XXX_sp.", sep = "")
} else 
  if (tax.clean[i,6] == ""){class <- paste(tax.clean[i,5], "_X", sep = "")
  tax.clean[i, 6] <- class
  tax.clean[i, 7] <- paste(class,"X", sep = "")
  tax.clean[i, 8] <- paste(class,"XX", sep = "")
  tax.clean[i, 9] <- paste(class,"XX_sp.", sep = "")
} else 
  if (tax.clean[i,7] == ""){order <- paste(tax.clean[i,6], "_X", sep = "")
  tax.clean[i, 7] <- order
  tax.clean[i, 8] <- paste(order,"X", sep = "")
  tax.clean[i, 9] <- paste(order,"X_sp.", sep = "")
} else 
  if (tax.clean[i,8] == ""){family <- paste(tax.clean[i,7], "_X", sep = "")
  tax.clean[i, 8] <- family
  tax.clean[i, 9] <- paste(family,"X_sp.", sep = "")
} else 
  if (tax.clean[i,9] == ""){tax.clean$Species[i] <- paste(tax.clean$Genus[i], "sp.",sep = "_")}
}
View(tax.clean)


tax_table(ps_diel_filtered) <- as.matrix(tax.clean)
```


#Subset phyloseq objects 
```{r}
#DIEL
#ps_diel <- <- subset_samples(ps_filtered, ps_filtered@sam_data$project=='Diel' |
#                                          ps_filtered@sam_data$project=='Diel' &
#                                          ps_filtered@sam_data$host=='Water' )



#SYMBIONT REMOVAL\
diel <- subset_taxa(ps_diel_filtered, (Order!="Suessiales"| is.na(Order)))
dielsymb <- subset_taxa(ps_diel_filtered, (Order=="Suessiales"))

diel
dielsymb

diel_pstrw <- subset_samples(diel, diel@sam_data$host=='Pseudodiploria strigosa' |
                                      diel@sam_data$host=='Water')
dielsymb_pstrw <- subset_samples(dielsymb, diel@sam_data$host=='Pseudodiploria strigosa' |
                                      diel@sam_data$host=='Water')

diel_pstr <- subset_samples(diel, diel@sam_data$host=='Pseudodiploria strigosa')
diel_pstr_all <- subset_samples(ps_diel_filtered, diel@sam_data$host=='Pseudodiploria strigosa')
dielsymb_pstr <- subset_samples(dielsymb, diel@sam_data$host=='Pseudodiploria strigosa')



##################################################################################
##################################################################################
###                                  Ordering                                  ###
##################################################################################
##################################################################################

#Eukaryotic Taxonomy
euk_supergroup <- read.csv("/path/to/data/curacao/metabarcoding/data/ordering/euk_supergroup.txt",header=F)
euksupergroup <- euk_supergroup %>% pull(V1)
euk_division <- read.csv("/path/to/data/curacao/metabarcoding/data/ordering/euk_division.txt",header=F)
eukdivision <- euk_division %>% pull(V1)
euk_subdivision <- read.csv("/path/to/data/curacao/metabarcoding/data/ordering/euk_subdivision.txt",header=F)
euksubdivision <- euk_subdivision %>% pull(V1)
euk_class <- read.csv("/path/to/data/curacao/metabarcoding/data/ordering/euk_class.txt",header=F)
eukclass <- euk_class %>% pull(V1)
euk_order <- read.csv("/path/to/data/curacao/metabarcoding/data/ordering/euk_order.txt",header=F)
eukorder <- euk_order %>% pull(V1)
euk_family <- read.csv("/path/to/data/curacao/metabarcoding/data/ordering/euk_family.txt",header=F)
eukfamily <- euk_family %>% pull(V1)
euk_genus <- read.csv("/path/to/data/curacao/metabarcoding/data/ordering/euk_genus.txt",header=F)
eukgenus <- euk_genus %>% pull(V1)
euk_species <- read.csv("/path/to/data/curacao/metabarcoding/data/ordering/euk_species.txt",header=F)
eukspecies <- euk_species %>% pull(V1)

#By Structure
time_order <- read.csv("/path/to/data/curacao/metabarcoding/data/ordering/time_order.txt",header=F)
timeorder <- time_order %>% pull(V1)
daytime_order <- read.csv("/path/to/data/curacao/metabarcoding/data/ordering/daytime_order.txt",header=F)
daytimeorder <- daytime_order %>% pull(V1)
diel_order <- read.csv("/path/to/data/curacao/metabarcoding/data/ordering/diel_order.txt",header=F)
dielorder <- diel_order %>% pull(V1)
dielpstr_order <- read.csv("/path/to/data/curacao/metabarcoding/data/ordering/dielpstr_order.txt",header=F)
dielpstrorder <- dielpstr_order %>% pull(V1)
dielpstr_day_order <- read.csv("/path/to/data/curacao/metabarcoding/data/ordering/dielpstr_day_order.txt",header=F)
dielpstrdayorder <- dielpstr_day_order %>% pull(V1)
```



#SUBSET PHYLOSEQ FOR SUBPHYLO OTU EXPLORATION
```{r}
#PSTR
#OTU Tables extraction
OTU = as(otu_table(diel_pstr), "matrix") 
OTU = t(OTU)
OTU = as.data.frame(OTU)
write.table(OTU, file = "/path/to/data/curacao/data/18s_diel/pstr/diel_pstr_otutable.tsv")
#TAX Table extraction
TAX = as(tax_table(diel_pstr), "matrix")
TAX = as.data.frame(TAX)
write.table(TAX, file = "/path/to/data/curacao/data/18s_diel/pstr/diel_pstr_taxtable.tsv")
#OTU Table w/ Tax Assignment extraction
OTU <- tibble::rownames_to_column(OTU, "ASV")
TAX <- tibble::rownames_to_column(TAX, "ASV")
OTUTAX<- merge(OTU, TAX, by= "ASV")
write.table(OTUTAX, file = "/path/to/data/curacao/data/18s_diel/pstr/diel_pstr_otutaxtable.tsv")
#write.table(OTUTAX, file = "~/Desktop/diel_pstr_otutaxtable.tsv")
```

##################################################################################
##                            Colour Palettes                                   ##
##################################################################################

# Colour Palettes
```{r}
library(randomcoloR)
n <- 64
palette <- distinctColorPalette(n)
c28 <- c(
  "dodgerblue2", "#E31A1C", # red
  "green4",
  "#6A3D9A", # purple
  "#FF7F00", # orange
  "black", "gold1",
  "skyblue2", "#FB9A99", # lt pink
  "palegreen2",
  "#CAB2D6", # lt purple
  "#FDBF6F", # lt orange
  "gray70", "khaki2",
  "maroon", "orchid1", "deeppink1", "blue1", "steelblue4",
  "darkturquoise", "green1", "yellow4", "yellow3",
  "darkorange4", "brown", "firebrick3", "darkslategray", "gray0"
)


day_palette <- c("midnightblue", "gold")
diel_palette <- c("midnightblue", "slategray", "gold", "orange")
diel_palette_ordered <- c("T12A"="midnightblue","T6A"="slategray","T12P"="gold","T6P"="orange")

safe_colorblind_palette <- c("#88CCEE", "#CC6677", "#DDCC77", "#117733", "#332288", "#AA4499", 
                             "#44AA99", "#999933", "#882255", "#661100", "#6699CC", "#888888")
                             

palette <- c("honeydew", "honeydew1", "honeydew2", "honeydew3", "honeydew4", "hotpink", "hotpink1", "hotpink2", "hotpink3", "hotpink4", "indianred", "indianred1", "indianred2", "indianred3", "indianred4", "ivory", "ivory1", "ivory2", "ivory3", "ivory4", "khaki", "khaki1", "khaki2", "khaki3", "khaki4", "lavender", "lavenderblush", "lavenderblush1", "lavenderblush2", "lavenderblush3", "lavenderblush4", "lawngreen", "lemonchiffon", "lemonchiffon1", "lemonchiffon2", "lemonchiffon3", "lemonchiffon4", "lightblue", "lightblue1", "lightblue2", "lightblue3", "lightblue4", "lightcoral", "lightcyan", "lightcyan1", "lightcyan2", "lightcyan3", "lightcyan4", "lightgoldenrod", "lightgoldenrod1", "lightgoldenrod2", "lightgoldenrod3", "lightgoldenrod4", "lightgoldenrodyellow", "lightgray", "lightgreen", "lightgrey", "lightpink", "lightpink1", "lightpink2", "lightpink3", "lightpink4", "lightsalmon", "lightsalmon1", "lightsalmon2", "lightsalmon3", "lightsalmon4", "lightseagreen", "lightskyblue", "lightskyblue1", "lightskyblue2", "lightskyblue3", "lightskyblue4", "lightslateblue", "lightslategray", "lightslategrey", "lightsteelblue", "lightsteelblue1", "lightsteelblue2", "lightsteelblue3", "lightsteelblue4", "lightyellow", "lightyellow1", "lightyellow2", "lightyellow3", "lightyellow4", "limegreen", "linen", "magenta", "magenta1", "magenta2", "magenta3", "magenta4", "maroon", "maroon1", "maroon2", "maroon3", "maroon4", "mediumaquamarine", "mediumblue", "mediumorchid", "mediumorchid1", "mediumorchid2", "mediumorchid3", "mediumorchid4", "mediumpurple", "mediumpurple1", "mediumpurple2", "mediumpurple3", "mediumpurple4", "mediumseagreen", "mediumslateblue", "mediumspringgreen", "mediumturquoise", "mediumvioletred", "midnightblue", "mintcream", "mistyrose", "mistyrose1", "mistyrose2", "mistyrose3", "mistyrose4", "moccasin", "navajowhite", "navajowhite1", "navajowhite2", "navajowhite3", "navajowhite4", "navy", "navyblue", "oldlace", "olivedrab", "olivedrab1", "olivedrab2", "olivedrab3", "olivedrab4", "orange", "orange1", "orange2", "orange3", "orange4", "orangered", "orangered1", "orangered2", "orangered3", "orangered4", "orchid", "orchid1", "orchid2", "orchid3", "orchid4", "palegoldenrod", "palegreen", "palegreen1", "palegreen2", "palegreen3", "palegreen4", "paleturquoise", "paleturquoise1", "paleturquoise2", "paleturquoise3", "paleturquoise4", "palevioletred", "palevioletred1", "palevioletred2", "palevioletred3", "palevioletred4", "papayawhip", "peachpuff", "peachpuff1", "peachpuff2", "peachpuff3", "peachpuff4", "peru", "pink", "pink1", "pink2", "pink3", "pink4", "plum", "plum1", "plum2", "plum3", "plum4", "powderblue", "purple", "purple1", "purple2", "purple3", "purple4", "red", "red1", "red2", "red3", "red4", "rosybrown", "rosybrown1", "rosybrown2", "rosybrown3", "rosybrown4", "royalblue", "royalblue1", "royalblue2", "royalblue3", "royalblue4", "saddlebrown", "salmon", "salmon1", "salmon2", "salmon3", "salmon4", "sandybrown", "seagreen", "seagreen1", "seagreen2", "seagreen3", "seagreen4", "seashell", "seashell1", "seashell2", "seashell3", "seashell4", "sienna", "sienna1", "sienna2", "sienna3", "sienna4", "skyblue", "skyblue1", "skyblue2", "skyblue3", "skyblue4", "slateblue", "slateblue1", "slateblue2", "slateblue3", "slateblue4", "slategray", "slategray1", "slategray2", "slategray3", "slategray4", "slategrey", "snow", "snow1", "snow2", "snow3", "snow4", "springgreen", "springgreen1", "springgreen2", "springgreen3", "springgreen4", "steelblue", "steelblue1", "steelblue2", "steelblue3", "steelblue4", "tan", "tan1", "tan2", "tan3", "tan4", "thistle", "thistle1", "thistle2", "thistle3", "thistle4", "tomato", "tomato1", "tomato2", "tomato3", "tomato4", "turquoise", "turquoise1", "turquoise2", "turquoise3", "turquoise4", "violet", "violetred", "violetred1", "violetred2", "violetred3", "violetred4", "wheat", "wheat1", "wheat2", "wheat3", "wheat4", "whitesmoke", "yellow", "yellow1", "yellow2", "yellow3", "yellow4", "yellowgreen")

eukdivision_palette <- c("Other"="slategrey","Stramenopiles"="skyblue","Alveolata"="sienna","Chlorophyta"="seagreen")
eukclass_palette <- c('Other'="slategrey", 'Bacillariophyceae'="#CC6677", 'Syndiniales'="#661100",'Dinophyceae'="#88CCEE", 'Oligohymenophorea'="#999933", 'Coccidiomorphea'="#117733", 'Ulvophyceae'="#DDCC77")
euksymbfamily_palette <- c("Other"="slategrey","Symbiodiniaceae"="#6699CC")
euksymbgenus_palette <- c("Other"="slategrey","Durusdinium"="#DDCC77","Cladocopium"="#999933","Breviolum"="#661100","Symbiodinium"="#6699CC")
```

##################################################################################
##################################################################################
##                                     Stats                                    ##
##################################################################################
##################################################################################

##################################################################################
##                                    Alpha                                     ##
##################################################################################

#PSTR w/o SYMB **SHANNON**
```{r}

ad_pstr <- prune_taxa(taxa_sums(diel_pstr) > 0, diel_pstr)
tab.shan <- microbiome::alpha(ad_pstr, index = "diversity_shannon")
kable(head(tab.shan))

ps1.meta <- meta(ad_pstr)
kable(head(ps1.meta))
ps1.meta$Shannon <- tab.shan$diversity_shannon 

# create a list of pairwise comparisons
fam <- unique(ps1.meta$diel_time) # get the variables

# make a pairwise list that we want to compare.
fam.pairs <- combn(seq_along(fam), 2, simplify = FALSE, FUN = function(i)fam[i])

print(fam.pairs)

pstr_dieltime_shan <- ggplot(ps1.meta, aes(x = factor(diel_time, levels= timeorder), y = Shannon)) +
                            geom_violinhalf(mapping = aes(fill = diel_time), scale = "width", width = 0.6, flip= TRUE, trim = FALSE) +
                            scale_fill_manual(values = diel_palette_ordered) +
                            scale_x_discrete(breaks=timeorder) +
                            geom_half_boxplot(mapping = aes(fill = diel_time),
                                              outlier.size = 0.01, width = 0.3, size = 0.5, alpha = 0.4, side = "r") +
                            #stat_compare_means(comparisons = fam.pairs) +
                            #stat_pvalue_manual(Shannon, hide.ns = F, y.position = y.position, label = "FDR.signif", 
                            #                   size = p.val.size, tip.length = 0) +
                            theme_classic() +
                            ylim(0,4.5) +
                            ylab("Shannon Diversity") +
                            xlab("Time of day") +
                            theme(axis.text.x = element_text(angle = 45, hjust = 1)) 
                            
                        

pdf("/path/to/data/curacao/metabarcoding/analysis/18s_diel/alpha/pstr_dieltime_alpha_shannon_ylim.pdf", width = 6, height = 6)
pstr_dieltime_shan
dev.off()
```

#PSTR SYMB ONLY **SHANNON**
```{r}

ad_pstr <- prune_taxa(taxa_sums(dielsymb_pstr) > 0, dielsymb_pstr)
tab.shan <- microbiome::alpha(ad_pstr, index = "diversity_shannon")
kable(head(tab.shan))

ps1.meta <- meta(ad_pstr)
kable(head(ps1.meta))
ps1.meta$Shannon <- tab.shan$diversity_shannon 

# create a list of pairwise comparisons
fam <- unique(ps1.meta$diel_time) # get the variables

# make a pairwise list that we want to compare.
fam.pairs <- combn(seq_along(fam), 2, simplify = FALSE, FUN = function(i)fam[i])

print(fam.pairs)

pstr_dieltime_shan <- ggplot(ps1.meta, aes(x = factor(diel_time, levels= timeorder), y = Shannon)) +
                            geom_violinhalf(mapping = aes(fill = diel_time), scale = "width", width = 0.6, flip= TRUE, trim = FALSE) +
                            scale_fill_manual(values = diel_palette_ordered) +
                            scale_x_discrete(breaks=timeorder) +
                            geom_half_boxplot(mapping = aes(fill = diel_time),
                                              outlier.size = 0.01, width = 0.3, size = 0.5, alpha = 0.4, side = "r") +
                            #stat_compare_means(comparisons = fam.pairs) +
                            #stat_pvalue_manual(Shannon, hide.ns = F, y.position = y.position, label = "FDR.signif", 
                            #                   size = p.val.size, tip.length = 0) +
                            theme_classic() +
                            ylim(0,3.5) + 
                            ylab("Shannon Diversity") +
                            xlab("Time of day") +
                            theme(axis.text.x = element_text(angle = 45, hjust = 1)) 
                            
                        

pdf("/path/to/data/curacao/metabarcoding/analysis/18s_diel/alpha/pstr_symb_dieltime_alpha_shannon_ylim2.pdf", width = 6, height = 6)
pstr_dieltime_shan
dev.off()
```

#PSTR w/o SYMB **rich**
```{r}

ad_pstr <- prune_taxa(taxa_sums(diel_pstr) > 0, diel_pstr)
tab.rich <- richness(ad_pstr)
kable(head(tab.rich))

ps1.meta <- meta(ad_pstr)
kable(head(ps1.meta))
ps1.meta$Richness <- tab.rich$observed

# create a list of pairwise comparisons
fam <- unique(ps1.meta$diel_time) # get the variables

# make a pairwise list that we want to compare.
fam.pairs <- combn(seq_along(fam), 2, simplify = FALSE, FUN = function(i)fam[i])

print(fam.pairs)

pstr_dieltime_rich <- ggplot(ps1.meta, aes(x = factor(diel_time, levels= timeorder), y = Richness)) +
                            geom_violinhalf(mapping = aes(fill = diel_time), scale = "width", width = 0.6, flip= TRUE, trim = FALSE) +
                            scale_fill_manual(values = diel_palette_ordered) +
                            scale_x_discrete(breaks=timeorder) +
                            geom_half_boxplot(mapping = aes(fill = diel_time),
                                              outlier.size = 0.01, width = 0.3, size = 0.5, alpha = 0.4, side = "r") +
                            #stat_compare_means(comparisons = fam.pairs) +
                            #stat_pvalue_manual(richnon, hide.ns = F, y.position = y.position, label = "FDR.signif", 
                            #                   size = p.val.size, tip.length = 0) +
                            theme_classic() +
                            ylim(0,750) +
                            ylab("Richness Diversity") +
                            xlab("Time of day") +
                            theme(axis.text.x = element_text(angle = 45, hjust = 1))
                            
                        

pdf("/path/to/data/curacao/metabarcoding/analysis/18s_diel/alpha/pstr_dieltime_alpha_rich_ylim.pdf", width = 6, height = 6)
pstr_dieltime_rich
dev.off()
```

#PSTR SYMB ONLY **rich**
```{r}

ad_pstr <- prune_taxa(taxa_sums(dielsymb_pstr) > 0, dielsymb_pstr)
tab.rich <- richness(ad_pstr)
kable(head(tab.rich))

ps1.meta <- meta(ad_pstr)
kable(head(ps1.meta))
ps1.meta$Richness <- tab.rich$observed 

# create a list of pairwise comparisons
fam <- unique(ps1.meta$diel_time) # get the variables

# make a pairwise list that we want to compare.
fam.pairs <- combn(seq_along(fam), 2, simplify = FALSE, FUN = function(i)fam[i])

print(fam.pairs)

pstr_dieltime_rich <- ggplot(ps1.meta, aes(x = factor(diel_time, levels= timeorder), y = Richness)) +
                            geom_violinhalf(mapping = aes(fill = diel_time), scale = "width", width = 0.6, flip= TRUE, trim = FALSE) +
                            scale_fill_manual(values = diel_palette_ordered) +
                            scale_x_discrete(breaks=timeorder) +
                            geom_half_boxplot(mapping = aes(fill = diel_time),
                                              outlier.size = 0.01, width = 0.3, size = 0.5, alpha = 0.4, side = "r") +
                            #stat_compare_means(comparisons = fam.pairs) +
                            #stat_pvalue_manual(richnon, hide.ns = F, y.position = y.position, label = "FDR.signif", 
                            #                   size = p.val.size, tip.length = 0) +
                            theme_classic() +
                            ylim(0,750) +
                            ylab("Richness Diversity") +
                            xlab("Time of day") +
                            theme(axis.text.x = element_text(angle = 45, hjust = 1)) 
                            
                        

pdf("/path/to/data/curacao/metabarcoding/analysis/18s_diel/alpha/pstr_symb_dieltime_alpha_rich_ylim.pdf", width = 6, height = 6)
pstr_dieltime_rich
dev.off()

```


##################################################################################
##                                 Aitchison PCA                                ##
##################################################################################

#################################################################################
##############                        PSTR                         ##############
#################################################################################

#PCA w/o SYMBIONTS
```{r}
pstr_clr <- microbiome::transform(diel_pstr, 'clr', shift = 1)

pstr_clr.ord <- ordinate(pstr_clr, "RDA", "euclidean")

#pca_pstr_title <- expression(paste("18S Aitchison distance PCA for ", italic("P. strigosa "), "through time"))

pca_pstr_diel = plot_ordination(pstr_clr, pstr_clr.ord, 
                                    shape=1,
                                    color="diel_time"#,
                                    #title=pca_pstr_title
                                    ) + 
                                    theme_classic() + 
                                    geom_point(aes(color = diel_time), alpha = 0.8, size = 3) + 
                                    scale_colour_manual(values=diel_palette_ordered) + 
                                    stat_ellipse(lwd=1)

pca_pstr_diel

pdf("/path/to/data/curacao/metabarcoding/analysis/18s_diel/beta/pstr_pca_dieltime_clean.pdf", width = 6, height = 6)
pca_pstr_diel
dev.off()

# Extract CLR matrix
clr_mat <- as.data.frame(t(otu_table(pstr_clr)))

# Compute Euclidean distance (Aitchison after CLR)
clr_dist <- dist(clr_mat, method = "euclidean")

# Get sample metadata as a clean data frame
meta <- data.frame(sample_data(pstr_clr))
meta$diel_time <- as.factor(meta$diel_time)

# PERMANOVA
set.seed(123)
adonis_res <- adonis2(clr_dist ~ diel_time, data = meta, permutations = 999)
print(adonis_res)
```

#PCA **WATER**
```{r}
pstr_clr <- microbiome::transform(diel_w, 'clr', shift = 1)

pstr_clr.ord <- ordinate(pstr_clr, "RDA", "euclidean")

#pca_pstr_title <- expression(paste("18S Aitchison distance PCA for ", italic("P. strigosa "), "through time"))

pca_pstr_diel = plot_ordination(pstr_clr, pstr_clr.ord, 
                                    shape=1,
                                    color="diel_time"#,
                                    #title=pca_pstr_title
                                    ) + 
                                    theme_classic() + 
                                    geom_point(aes(color = diel_time), alpha = 0.8, size = 3) + 
                                    #scale_colour_manual(values=diel_palette_ordered) + 
                                    stat_ellipse(aes(color = diel_day), lwd = 1)

pca_pstr_diel

pdf("/path/to/data/analysis/pstr_18s_diel/beta/pstr_pca_dieltime_water_ellipses.pdf", width = 6, height = 6)
pca_pstr_diel
dev.off()

# 1. Extract CLR matrix (samples x features)
clr_mat <- as.data.frame(t(otu_table(pstr_clr)))

# 2. Compute Euclidean distance (Aitchison after CLR)
clr_dist <- dist(clr_mat, method = "euclidean")

# 3. Get sample metadata as a clean data frame
meta <- data.frame(sample_data(pstr_clr))
meta$diel_time <- as.factor(meta$diel_time)  # ensure it's a factor

# 4. PERMANOVA
set.seed(123)
adonis_res <- adonis2(clr_dist ~ diel_day, data = meta, permutations = 999)
print(adonis_res)
```

#PCA w/o SYMBIONTS **OTHER VARIABLES**
```{r}
pstr_clr <- microbiome::transform(diel_pstr, 'clr', shift = 1)

pstr_clr.ord <- ordinate(pstr_clr, "RDA", "euclidean")

#pca_pstr_title <- expression(paste("18S Aitchison distance PCA for ", italic("P. strigosa "), "through time"))

pca_pstr_diel = plot_ordination(pstr_clr, pstr_clr.ord, 
                                    shape=1,
                                    color="diel_code",
                                    title=pca_pstr_title) + 
                                    theme_classic() + 
                                    #geom_point(aes(color = c("midnightblue", "gold")), alpha = 0.8, size = 3) + 
                                    #scale_colour_manual(values=diel_palette_ordered) + 
                                    stat_ellipse(lwd=1)

pca_pstr_diel

pdf("/path/to/data/curacao/metabarcoding/analysis/18s_diel/beta/pstr_pca_variable_clean.pdf", width = 6, height = 6)
pca_pstr_diel
dev.off()
```

#PCA SYMBIONTS
```{r}
pstr_clr <- microbiome::transform(dielsymb_pstr, 'clr', shift = 1)

pstr_clr.ord <- ordinate(pstr_clr, "RDA", "euclidean")

#pca_pstr_title <- expression(paste("Symbiont Aitchison distance PCA for ", italic("P. strigosa "), "through time"))

pca_pstr_diel = plot_ordination(pstr_clr, pstr_clr.ord, 
                                    shape=1,
                                    color="diel_time"#,
                                    #title=pca_pstr_title
                                    ) + 
                                    theme_classic() + 
                                    geom_point(aes(color = diel_time), alpha = 0.8, size = 3) + 
                                    scale_colour_manual(values=diel_palette_ordered) + 
                                    stat_ellipse(lwd=1)

pca_pstr_diel

pdf("/path/to/data/curacao/metabarcoding/analysis/18s_diel/beta/pstr_symb_pca_dieltime_clean.pdf", width = 6, height = 6)
pca_pstr_diel
dev.off()

# 1. Extract CLR matrix (samples x features)
clr_mat <- as.data.frame(t(otu_table(pstr_clr)))

# 2. Compute Euclidean distance (Aitchison after CLR)
clr_dist <- dist(clr_mat, method = "euclidean")

# 3. Get sample metadata as a clean data frame
meta <- data.frame(sample_data(pstr_clr))
meta$diel_time <- as.factor(meta$diel_time)  # ensure it's a factor

# 4. PERMANOVA
set.seed(123)
adonis_res <- adonis2(clr_dist ~ diel_time, data = meta, permutations = 999)
print(adonis_res)
```



##################################################################################
#######                             Bubble Plots                            ######
#######                            (Standard Dev)                           ######
##################################################################################

#################################################################################
##############                        PSTR                         ##############
#################################################################################

# PSTR by diel time w/ STANDARD DEV **GENUS LEVEL W/O SYMBIODINIACEAE**
```{r}

sd_diel_pstr <- diel_pstr %>% 
  tax_glom(taxrank = "Genus") %>% 
  transform_sample_counts(function(x) {x/sum(x)*100} ) %>% 
  psmelt() %>% group_by(OTU, diel_time)  %>%
  summarize(sd = sd(Abundance, na.rm=FALSE)) %>% arrange(OTU)

bubSD_diel_pstr <- merge_samples(diel_pstr, diel_pstr@sam_data$diel_time) 
type_taxa_diel_pstr <- bubSD_diel_pstr %>% 
  tax_glom(taxrank = "Genus") %>% 
  transform_sample_counts(function(x) {x/sum(x)*100} )  

type_taxa_diel_pstr <- type_taxa_diel_pstr %>% 
  psmelt() %>% 
  arrange(OTU) 

library(data.table)
# create dataframe from phyloseq object
dat_diel_pstr <- data.table(type_taxa_diel_pstr)

dat_diel_pstr$SD <- sd_diel_pstr$sd
# convert Division to a character vector from a factor because R
dat_diel_pstr$Genus <- as.character(dat_diel_pstr$Genus)
# group dataframe by Division, calculate median rel. abundance
dat_diel_pstr[, median := median(Abundance, na.rm = FALSE), 
    by = "Genus"]
# Change name to remainder of Division less than 2%
dat_diel_pstr[(median <= 0.01), Genus := "Below Threshold"]
dat_diel_pstr[(Genus == "Below Threshold"), Division := "Other"]

bubSD_diel_pstr_title <- expression(paste("Eukaryotic Genus (Excluding Symbiodiniaceae) within ", italic("P. strigosa")))

bpSD_diel_pstr <- ggplot(dat_diel_pstr[Abundance > 0], aes(x = factor(Sample, levels=timeorder), y = factor(Genus, levels=eukgenus))) + geom_point(aes(size = Abundance, fill=Division, color=Division), alpha = 0.5, shape = 21) + 
  scale_size_continuous(limits = c(0.000001, 100), range = c(0.1,10), breaks = c(1,10,50,75)) + 
  labs( x= "Time of Day", y = "Eukaryotic Genus", size = "Relative Abundance %", fill="Division") + theme_bw() +  
  scale_fill_manual(values = eukdivision_palette, breaks=c('Other', 'Stramenopiles', 'Alveolata', 'Chlorophyta')) +
  scale_color_manual(values = eukdivision_palette,breaks=c('Other', 'Stramenopiles', 'Alveolata', 'Chlorophyta')) + 
  theme(axis.text.x = element_text(angle = 90, vjust = .5, hjust=1)) + 
  #ggtitle(label=bubSD_diel_pstr_title, subtitle = "With median relative abundance above 1%") + 
  geom_point(aes(size=Abundance+SD, fill = Division, color=Division), alpha = 0.20, shape=21) + geom_point(aes(size=Abundance-SD, fill = Division, color=Division), alpha = 1, shape=21) + guides(color = "none", fill = guide_legend(override.aes = list(size = 3)))
bpSD_diel_pstr

pdf("/path/to/data/curacao/metabarcoding/analysis/18s_diel/community/pstr_bpSD_diel_genus_clean.pdf", width = 6, height = 4.5)
bpSD_diel_pstr
dev.off()
```


# PSTR by diel time w/ STANDARD DEV **GENUS LEVEL W/O SYMBIODINIACEAE** DIVISION GOES TO CLASS
```{r}

sd_diel_pstr <- diel_pstr %>% 
  tax_glom(taxrank = "Genus") %>% 
  transform_sample_counts(function(x) {x/sum(x)*100} ) %>% 
  psmelt() %>% group_by(OTU, diel_time)  %>%
  summarize(sd = sd(Abundance, na.rm=FALSE)) %>% arrange(OTU)

bubSD_diel_pstr <- merge_samples(diel_pstr, diel_pstr@sam_data$diel_time) 
type_taxa_diel_pstr <- bubSD_diel_pstr %>% 
  tax_glom(taxrank = "Genus") %>% 
  transform_sample_counts(function(x) {x/sum(x)*100} )  

type_taxa_diel_pstr <- type_taxa_diel_pstr %>% 
  psmelt() %>% 
  arrange(OTU) 

library(data.table)
# create dataframe from phyloseq object
dat_diel_pstr <- data.table(type_taxa_diel_pstr)

dat_diel_pstr$SD <- sd_diel_pstr$sd
# convert Class to a character vector from a factor because R
dat_diel_pstr$Genus <- as.character(dat_diel_pstr$Genus)
# group dataframe by Class, calculate median rel. abundance
dat_diel_pstr[, median := median(Abundance, na.rm = FALSE), 
    by = "Genus"]
# Change name to remainder of Class less than 2%
dat_diel_pstr[(median <= 0.01), Genus := "Below Threshold"]
dat_diel_pstr[(Genus == "Below Threshold"), Class := "Other"]

bubSD_diel_pstr_title <- expression(paste("Eukaryotic Genus (Excluding Symbiodiniaceae) within ", italic("P. strigosa")))

bpSD_diel_pstr <- ggplot(dat_diel_pstr[Abundance > 0], aes(x = factor(Sample, levels=timeorder), y = factor(Genus, levels=eukgenus))) + geom_point(aes(size = Abundance, fill=Class, color=Class), alpha = 0.5, shape = 21) + 
  scale_size_continuous(limits = c(0.000001, 100), range = c(0.1,10), breaks = c(1,10,50,75)) + 
  labs( x= "Time of Day", y = "Eukaryotic Genus", size = "Relative Abundance %", fill="Class") + theme_bw() +  
  scale_fill_manual(values = eukclass_palette, breaks=c('Other', 'Bacillariophyceae', 'Syndiniales', 'Dinophyceae',   'Oligohymenophorea', 'Coccidiomorphea', 'Ulvophyceae')) +
  scale_color_manual(values = eukclass_palette,breaks=c('Other', 'Bacillariophyceae', 'Syndiniales', 'Dinophyceae',   'Oligohymenophorea', 'Coccidiomorphea', 'Ulvophyceae')) + 
  theme(axis.text.x = element_text(angle = 90, vjust = .5, hjust=1)) + 
  #ggtitle(label=bubSD_diel_pstr_title, subtitle = "With median relative abundance above 1%") + 
  geom_point(aes(size=Abundance+SD, fill = Class, color=Class), alpha = 0.20, shape=21) + geom_point(aes(size=Abundance-SD, fill = Class, color=Class), alpha = 1, shape=21) + guides(color = "none", fill = guide_legend(override.aes = list(size = 3)))
bpSD_diel_pstr


pdf("/path/to/data/curacao/metabarcoding/analysis/18s_diel/community/pstr_bpSD_diel_genus_clean_newtax.pdf", width = 6, height = 4.5)
bpSD_diel_pstr
dev.off()
```

# PSTR by diel time w/ STANDARD DEV *Genus LEVEL SYMBIODINIACEAE**
```{r}
sd_dielsymb_pstr <- dielsymb_pstr %>% 
  tax_glom(taxrank = "Genus") %>% 
  transform_sample_counts(function(x) {x/sum(x)*100} ) %>% 
  psmelt() %>% group_by(OTU, diel_time)  %>%
  summarize(sd = sd(Abundance, na.rm=FALSE)) %>% arrange(OTU)

bubSD_dielsymb_pstr <- merge_samples(dielsymb_pstr, dielsymb_pstr@sam_data$diel_time) 
type_taxa_dielsymb_pstr <- bubSD_dielsymb_pstr %>% 
  tax_glom(taxrank = "Genus") %>% 
  transform_sample_counts(function(x) {x/sum(x)*100} )  

type_taxa_dielsymb_pstr <- type_taxa_dielsymb_pstr %>% 
  psmelt() %>% 
  arrange(OTU) 

library(data.table)
# create dataframe from phyloseq object
dat_dielsymb_pstr <- data.table(type_taxa_dielsymb_pstr)

dat_dielsymb_pstr$SD <- sd_dielsymb_pstr$sd
# convert Genus to a character vector from a factor because R
dat_dielsymb_pstr$Genus <- as.character(dat_dielsymb_pstr$Genus)
# group dataframe by Genus, calculate median rel. abundance
dat_dielsymb_pstr[, median := median(Abundance, na.rm = FALSE), 
    by = "Genus"]
# Change name to remainder of Genus less than 2%
dat_dielsymb_pstr[(median <= 0.01), Genus := "Below Threshold"]
dat_dielsymb_pstr[(Genus == "Below Threshold"), Family := "Other"]

bubSD_dielsymb_pstr_title <- expression(paste("Genera of Symbiodiniaceae within ", italic("P. strigosa")))

bpSD_dielsymb_pstr <- ggplot(dat_dielsymb_pstr[Abundance > 0], aes(x = factor(Sample, levels=timeorder), y = factor(Genus, levels=eukgenus))) + geom_point(aes(size = Abundance, fill=Family, color=Family), alpha = 0.5, shape = 21) + 
  scale_size_continuous(limits = c(0.000001, 100), range = c(0.1,10), breaks = c(1,10,50,75)) + 
  labs( x= "Time of Day", y = "Eukaryotic Genera", size = "Relative Abundance %", fill="Family") + theme_bw() +  
  scale_fill_manual(values = euksymbfamily_palette, breaks=c('Other', 'Symbiodiniaceae')) +
  scale_color_manual(values = euksymbfamily_palette,breaks=c('Other', 'Symbiodiniaceae')) + 
  theme(axis.text.x = element_text(angle = 90, vjust = .5, hjust=1)) + 
  ggtitle(label=bubSD_dielsymb_pstr_title, subtitle = "With median relative abundance above 1%") + geom_point(aes(size=Abundance+SD, fill = Family, color=Family), alpha = 0.20, shape=21) + geom_point(aes(size=Abundance-SD, fill = Family, color=Family), alpha = 1, shape=21) + guides(color = "none", fill = guide_legend(override.aes = list(size = 3)))
bpSD_dielsymb_pstr

pdf("/path/to/data/curacao/metabarcoding/analysis/18s_diel/community/pstr_symb_bpSD_diel_genusfamily.pdf", width = 5.25, height = 3)
bpSD_dielsymb_pstr
dev.off()
```



##################################################################################
##################################################################################
###                                   ANCOM-BC                                 ###
##################################################################################
##################################################################################

#PSTR
```{r}
#Subset the phyloseq object to contain only the samples and variables you want to explore
pstr_12A_6A <- subset_samples(diel_pstr,  diel_pstr@sam_data$diel_time=='T12A' |
                                             diel_pstr@sam_data$diel_time=='T6A')

ancom_pstr_12A_6A = ancombc2(data = pstr_12A_6A, assay_name = "counts", tax_level = NULL,
                  fix_formula = "diel_time", rand_formula = NULL,
                  p_adj_method = "fdr", pseudo = 0, pseudo_sens = TRUE,
                  prv_cut = 0.01, lib_cut = 0, s0_perc = 0.05,
                  group = "diel_time", struc_zero = TRUE, neg_lb = FALSE,
                  alpha = 0.05, n_cl = 2, verbose = TRUE,
                  global = FALSE, pairwise = TRUE, dunnet = FALSE, trend = FALSE, #Change this when more than 1 factor or time points
                  iter_control = list(tol = 1e-2, max_iter = 20, 
                                      verbose = TRUE),
                  em_control = list(tol = 1e-5, max_iter = 100),
                  lme_control = lme4::lmerControl(),
                  mdfdr_control = list(fwer_ctrl_method = "fdr", B = 100),
                  trend_control = list(contrast = list(matrix(c(1, 0, -1, 1),
                                                              nrow = 2, 
                                                              byrow = TRUE),
                                                       matrix(c(-1, 0, 1, -1),
                                                              nrow = 2, 
                                                              byrow = TRUE)),
                                       node = list(2, 2),
                                       solver = "ECOS",
                                       B = 100))

res_prim_pstr_12A_6A = ancom_pstr_12A_6A$res
res_prim_pstr_12A_6A
df_res_pstr_12A_6A = res_prim_pstr_12A_6A %>% dplyr::filter(`diff_diel_timeT6A`) %>%
    dplyr::select(taxon, contains("diel_time")) #CHANGE ME TO VARIABLE

df_fig_res_pstr_12A_6A = df_res_pstr_12A_6A %>% 
    arrange(desc(`lfc_diel_timeT6A`
)) %>%
    mutate(direct = ifelse(`lfc_diel_timeT6A`
 > 0, "Positive LFC", "Negative LFC"))


df_fig_res_pstr_12A_6A$taxon = factor(df_fig_res_pstr_12A_6A$taxon, levels = df_fig_res_pstr_12A_6A$taxon)
df_fig_res_pstr_12A_6A$direct = factor(df_fig_res_pstr_12A_6A$direct, 
                           levels = c("Positive LFC", "Negative LFC"))
  
df_fig_res_pstr_12A_6A.df = as.data.frame(df_fig_res_pstr_12A_6A)
write.table(df_fig_res_pstr_12A_6A.df, file = "/path/to/data/curacao/metabarcoding/analysis/18s_diel/ancom/ancom_pstr_12A_6A.tsv")


fig_res_pstr_12A_6A = df_fig_res_pstr_12A_6A %>%
    ggplot(aes(x = taxon, y = `lfc_diel_timeT6A`, fill = `lfc_diel_timeT6A`)) + 
    geom_bar(stat = "identity", width = 0.7, color = "black", 
             position = position_dodge(width = 0.4)) +
    geom_errorbar(aes(ymin = `lfc_diel_timeT6A` - `se_diel_timeT6A`, ymax = `lfc_diel_timeT6A` + `se_diel_timeT6A`), 
                  width = 0.2, position = position_dodge(0.05), color = "black") + 
    labs(x = "Prokaryotic Order", y = "Log fold change", 
         title = "LFC from T12A to T6A", subtitle = "ANCOM-BC derived signficant taxa") + scale_fill_viridis_c(option = "plasma") + scale_color_viridis_c(option = "plasma") +
  theme_bw() + 
  theme(legend.position = "none",
        panel.grid.minor.y = element_blank()) + coord_flip()

fig_res_pstr_12A_6A

pdf("/path/to/data/curacao/metabarcoding/analysis/18s_diel/ancom/ancom_pstr_12A_6A.pdf", width = 13, height = 20)
fig_res_pstr_12A_6A
dev.off()


#Subset the phyloseq object to contain only the samples and variables you want to explore
pstr_6A_12P <- subset_samples(diel_pstr,  diel_pstr@sam_data$diel_time=='T6A' |
                                             diel_pstr@sam_data$diel_time=='T12P')

ancom_pstr_6A_12P = ancombc2(data = pstr_6A_12P, assay_name = "counts", tax_level = NULL,
                  fix_formula = "diel_time", rand_formula = NULL,
                  p_adj_method = "fdr", pseudo = 0, pseudo_sens = TRUE,
                  prv_cut = 0.01, lib_cut = 0, s0_perc = 0.05,
                  group = "diel_time", struc_zero = TRUE, neg_lb = FALSE,
                  alpha = 0.05, n_cl = 2, verbose = TRUE,
                  global = FALSE, pairwise = TRUE, dunnet = FALSE, trend = FALSE, #Change this when more than 1 factor or time points
                  iter_control = list(tol = 1e-2, max_iter = 20, 
                                      verbose = TRUE),
                  em_control = list(tol = 1e-5, max_iter = 100),
                  lme_control = lme4::lmerControl(),
                  mdfdr_control = list(fwer_ctrl_method = "fdr", B = 100),
                  trend_control = list(contrast = list(matrix(c(1, 0, -1, 1),
                                                              nrow = 2, 
                                                              byrow = TRUE),
                                                       matrix(c(-1, 0, 1, -1),
                                                              nrow = 2, 
                                                              byrow = TRUE)),
                                       node = list(2, 2),
                                       solver = "ECOS",
                                       B = 100))

res_prim_pstr_6A_12P = ancom_pstr_6A_12P$res
res_prim_pstr_6A_12P
df_res_pstr_6A_12P = res_prim_pstr_6A_12P %>% dplyr::filter(diff_diel_timeT6A) %>%
    dplyr::select(taxon, contains("diel_time")) #CHANGE ME TO VARIABLE

df_fig_res_pstr_6A_12P = df_res_pstr_6A_12P %>% 
    arrange(desc(`lfc_diel_timeT6A`
)) %>%
    mutate(direct = ifelse(`lfc_diel_timeT6A`
 > 0, "Positive LFC", "Negative LFC"))


df_fig_res_pstr_6A_12P$taxon = factor(df_fig_res_pstr_6A_12P$taxon, levels = df_fig_res_pstr_6A_12P$taxon)
df_fig_res_pstr_6A_12P$direct = factor(df_fig_res_pstr_6A_12P$direct, 
                           levels = c("Positive LFC", "Negative LFC"))
  
df_fig_res_pstr_6A_12P.df = as.data.frame(df_fig_res_pstr_6A_12P)
write.table(df_fig_res_pstr_6A_12P.df, file = "/path/to/data/curacao/metabarcoding/analysis/18s_diel/ancom/ancom_pstr_6A_12P.tsv")


fig_res_pstr_6A_12P = df_fig_res_pstr_6A_12P %>%
    ggplot(aes(x = taxon, y = `lfc_diel_timeT6A`, fill = `lfc_diel_timeT6A`)) + 
    geom_bar(stat = "identity", width = 0.7, color = "black", 
             position = position_dodge(width = 0.4)) +
    geom_errorbar(aes(ymin = `lfc_diel_timeT6A` - `se_diel_timeT6A`, ymax = `lfc_diel_timeT6A` + `se_diel_timeT6A`), 
                  width = 0.2, position = position_dodge(0.05), color = "black") + 
    labs(x = "Prokaryotic Order", y = "Log fold change", 
         title = "LFC from T6A to T12P", subtitle = "ANCOM-BC derived signficant taxa") + scale_fill_viridis_c(option = "plasma") + scale_color_viridis_c(option = "plasma") +
  theme_bw() + 
  theme(legend.position = "none",
        panel.grid.minor.y = element_blank()) + coord_flip()

fig_res_pstr_6A_12P

pdf("/path/to/data/curacao/metabarcoding/analysis/18s_diel/ancom/ancom_pstr_6A_12P.pdf", width = 13, height = 20)
fig_res_pstr_6A_12P
dev.off()


#Subset the phyloseq object to contain only the samples and variables you want to explore
pstr_12P_6P <- subset_samples(diel_pstr,  diel_pstr@sam_data$diel_time=='T12P' |
                                             diel_pstr@sam_data$diel_time=='T6P')

ancom_pstr_12P_6P = ancombc2(data = pstr_12P_6P, assay_name = "counts", tax_level = NULL,
                  fix_formula = "diel_time", rand_formula = NULL,
                  p_adj_method = "fdr", pseudo = 0, pseudo_sens = TRUE,
                  prv_cut = 0.01, lib_cut = 0, s0_perc = 0.05,
                  group = "diel_time", struc_zero = TRUE, neg_lb = FALSE,
                  alpha = 0.05, n_cl = 2, verbose = TRUE,
                  global = FALSE, pairwise = TRUE, dunnet = FALSE, trend = FALSE, #Change this when more than 1 factor or time points
                  iter_control = list(tol = 1e-2, max_iter = 20, 
                                      verbose = TRUE),
                  em_control = list(tol = 1e-5, max_iter = 100),
                  lme_control = lme4::lmerControl(),
                  mdfdr_control = list(fwer_ctrl_method = "fdr", B = 100),
                  trend_control = list(contrast = list(matrix(c(1, 0, -1, 1),
                                                              nrow = 2, 
                                                              byrow = TRUE),
                                                       matrix(c(-1, 0, 1, -1),
                                                              nrow = 2, 
                                                              byrow = TRUE)),
                                       node = list(2, 2),
                                       solver = "ECOS",
                                       B = 100))

res_prim_pstr_12P_6P = ancom_pstr_12P_6P$res
res_prim_pstr_12P_6P
df_res_pstr_12P_6P = res_prim_pstr_12P_6P %>% dplyr::filter(diff_diel_timeT6P) %>%
    dplyr::select(taxon, contains("diel_time")) #CHANGE ME TO VARIABLE

df_fig_res_pstr_12P_6P = df_res_pstr_12P_6P %>% 
    arrange(desc(`lfc_diel_timeT6P`
)) %>%
    mutate(direct = ifelse(`lfc_diel_timeT6P`
 > 0, "Positive LFC", "Negative LFC"))


df_fig_res_pstr_12P_6P$taxon = factor(df_fig_res_pstr_12P_6P$taxon, levels = df_fig_res_pstr_12P_6P$taxon)
df_fig_res_pstr_12P_6P$direct = factor(df_fig_res_pstr_12P_6P$direct, 
                           levels = c("Positive LFC", "Negative LFC"))
  
df_fig_res_pstr_12P_6P.df = as.data.frame(df_fig_res_pstr_12P_6P)
write.table(df_fig_res_pstr_12P_6P.df, file = "/path/to/data/curacao/metabarcoding/analysis/18s_diel/ancom/ancom_pstr_12P_6P.tsv")


fig_res_pstr_12P_6P = df_fig_res_pstr_12P_6P %>%
    ggplot(aes(x = taxon, y = `lfc_diel_timeT6P`, fill = `lfc_diel_timeT6P`)) + 
    geom_bar(stat = "identity", width = 0.7, color = "black", 
             position = position_dodge(width = 0.4)) +
    geom_errorbar(aes(ymin = `lfc_diel_timeT6P` - `se_diel_timeT6P`, ymax = `lfc_diel_timeT6P` + `se_diel_timeT6P`), 
                  width = 0.2, position = position_dodge(0.05), color = "black") + 
    labs(x = "Prokaryotic Order", y = "Log fold change", 
         title = "LFC from T6A to T12P", subtitle = "ANCOM-BC derived signficant taxa") + scale_fill_viridis_c(option = "plasma") + scale_color_viridis_c(option = "plasma") +
  theme_bw() + 
  theme(legend.position = "none",
        panel.grid.minor.y = element_blank()) + coord_flip()

fig_res_pstr_12P_6P

pdf("/path/to/data/curacao/metabarcoding/analysis/18s_diel/ancom/ancom_pstr_12P_6P.pdf", width = 13, height = 20)
fig_res_pstr_12P_6P
dev.off()



#Subset the phyloseq object to contain only the samples and variables you want to explore
pstr_6P_12A <- subset_samples(diel_pstr,  diel_pstr@sam_data$diel_time=='T6P' |
                                             diel_pstr@sam_data$diel_time=='T12A')

ancom_pstr_6P_12A = ancombc2(data = pstr_6P_12A, assay_name = "counts", tax_level = NULL,
                  fix_formula = "diel_time", rand_formula = NULL,
                  p_adj_method = "fdr", pseudo = 0, pseudo_sens = TRUE,
                  prv_cut = 0.01, lib_cut = 0, s0_perc = 0.05,
                  group = "diel_time", struc_zero = TRUE, neg_lb = FALSE,
                  alpha = 0.05, n_cl = 2, verbose = TRUE,
                  global = FALSE, pairwise = TRUE, dunnet = FALSE, trend = FALSE, #Change this when more than 1 factor or time points
                  iter_control = list(tol = 1e-2, max_iter = 20, 
                                      verbose = TRUE),
                  em_control = list(tol = 1e-5, max_iter = 100),
                  lme_control = lme4::lmerControl(),
                  mdfdr_control = list(fwer_ctrl_method = "fdr", B = 100),
                  trend_control = list(contrast = list(matrix(c(1, 0, -1, 1),
                                                              nrow = 2, 
                                                              byrow = TRUE),
                                                       matrix(c(-1, 0, 1, -1),
                                                              nrow = 2, 
                                                              byrow = TRUE)),
                                       node = list(2, 2),
                                       solver = "ECOS",
                                       B = 100))

res_prim_pstr_6P_12A = ancom_pstr_6P_12A$res
res_prim_pstr_6P_12A
df_res_pstr_6P_12A = res_prim_pstr_6P_12A %>% dplyr::filter(diff_diel_timeT6P) %>%
    dplyr::select(taxon, contains("diel_time")) #CHANGE ME TO VARIABLE

df_fig_res_pstr_6P_12A = df_res_pstr_6P_12A %>% 
    arrange(desc(`lfc_diel_timeT12A`
)) %>%
    mutate(direct = ifelse(`lfc_diel_timeT12A`
 > 0, "Positive LFC", "Negative LFC"))


df_fig_res_pstr_6P_12A$taxon = factor(df_fig_res_pstr_6P_12A$taxon, levels = df_fig_res_pstr_6P_12A$taxon)
df_fig_res_pstr_6P_12A$direct = factor(df_fig_res_pstr_6P_12A$direct, 
                           levels = c("Positive LFC", "Negative LFC"))
  
df_fig_res_pstr_6P_12A.df = as.data.frame(df_fig_res_pstr_6P_12A)
write.table(df_fig_res_pstr_6P_12A.df, file = "/path/to/data/curacao/metabarcoding/analysis/18s_diel/ancom/ancom_pstr_6P_12A.tsv")


fig_res_pstr_6P_12A = df_fig_res_pstr_6P_12A %>%
    ggplot(aes(x = taxon, y = `lfc_diel_timeT12A`, fill = `lfc_diel_timeT12A`)) + 
    geom_bar(stat = "identity", width = 0.7, color = "black", 
             position = position_dodge(width = 0.4)) +
    geom_errorbar(aes(ymin = `lfc_diel_timeT12A` - `se_diel_timeT12A`, ymax = `lfc_diel_timeT12A` + `se_diel_timeT12A`), 
                  width = 0.2, position = position_dodge(0.05), color = "black") + 
    labs(x = "Prokaryotic Order", y = "Log fold change", 
         title = "LFC from T6A to T12P", subtitle = "ANCOM-BC derived signficant taxa") + scale_fill_viridis_c(option = "plasma") + scale_color_viridis_c(option = "plasma") +
  theme_bw() + 
  theme(legend.position = "none",
        panel.grid.minor.y = element_blank()) + coord_flip()

fig_res_pstr_6P_12A

pdf("/path/to/data/curacao/metabarcoding/analysis/18s_diel/ancom/ancom_pstr_6P_12A.pdf", width = 13, height = 20)
fig_res_pstr_6P_12A
dev.off()

```

```{R}
#Subset the phyloseq object to contain only the samples and variables you want to explore
pstr_12A_12P <- subset_samples(diel_pstr,  diel_pstr@sam_data$diel_time=='T12A' |
                                             diel_pstr@sam_data$diel_time=='T12P')

ancom_pstr_12A_12P = ancombc2(data = pstr_12A_12P, assay_name = "counts", tax_level = NULL,
                  fix_formula = "diel_time", rand_formula = NULL,
                  p_adj_method = "fdr", pseudo = 0, pseudo_sens = TRUE,
                  prv_cut = 0.01, lib_cut = 0, s0_perc = 0.05,
                  group = "diel_time", struc_zero = TRUE, neg_lb = FALSE,
                  alpha = 0.05, n_cl = 2, verbose = TRUE,
                  global = FALSE, pairwise = TRUE, dunnet = FALSE, trend = FALSE, #Change this when more than 1 factor or time points
                  iter_control = list(tol = 1e-2, max_iter = 20, 
                                      verbose = TRUE),
                  em_control = list(tol = 1e-5, max_iter = 100),
                  lme_control = lme4::lmerControl(),
                  mdfdr_control = list(fwer_ctrl_method = "fdr", B = 100),
                  trend_control = list(contrast = list(matrix(c(1, 0, -1, 1),
                                                              nrow = 2, 
                                                              byrow = TRUE),
                                                       matrix(c(-1, 0, 1, -1),
                                                              nrow = 2, 
                                                              byrow = TRUE)),
                                       node = list(2, 2),
                                       solver = "ECOS",
                                       B = 100))

res_prim_pstr_12A_12P = ancom_pstr_12A_12P$res
res_prim_pstr_12A_12P
df_res_pstr_12A_12P = res_prim_pstr_12A_12P %>% dplyr::filter(diff_diel_timeT12P) %>%
    dplyr::select(taxon, contains("diel_time")) #CHANGE ME TO VARIABLE

df_fig_res_pstr_12A_12P = df_res_pstr_12A_12P %>% 
    arrange(desc(`lfc_diel_timeT12P`
)) %>%
    mutate(direct = ifelse(`lfc_diel_timeT12P`
 > 0, "Positive LFC", "Negative LFC"))


df_fig_res_pstr_12A_12P$taxon = factor(df_fig_res_pstr_12A_12P$taxon, levels = df_fig_res_pstr_12A_12P$taxon)
df_fig_res_pstr_12A_12P$direct = factor(df_fig_res_pstr_12A_12P$direct, 
                           levels = c("Positive LFC", "Negative LFC"))
  
df_fig_res_pstr_12A_12P.df = as.data.frame(df_fig_res_pstr_12A_12P)
write.table(df_fig_res_pstr_12A_12P.df, file = "/path/to/data/curacao/metabarcoding/analysis/18s_diel/ancom/ancom_pstr_12A_12P.tsv")


fig_res_pstr_12A_12P = df_fig_res_pstr_12A_12P %>%
    ggplot(aes(x = taxon, y = `lfc_diel_timeT12P`, fill = `lfc_diel_timeT12P`)) + 
    geom_bar(stat = "identity", width = 0.7, color = "black", 
             position = position_dodge(width = 0.4)) +
    geom_errorbar(aes(ymin = `lfc_diel_timeT12P` - `se_diel_timeT12P`, ymax = `lfc_diel_timeT12P` + `se_diel_timeT12P`), 
                  width = 0.2, position = position_dodge(0.05), color = "black") + 
    labs(x = "Eukaryotic Order", y = "Log fold change", 
         title = "LFC from T12A to T12P", subtitle = "ANCOM-BC derived signficant taxa") + scale_fill_viridis_c(option = "plasma") + scale_color_viridis_c(option = "plasma") +
  theme_bw() + 
  theme(legend.position = "none",
        panel.grid.minor.y = element_blank()) + coord_flip()

fig_res_pstr_12A_12P

pdf("/path/to/data/curacao/metabarcoding/analysis/18s_diel/ancom/ancom_pstr_12A_12P.pdf", width = 13, height = 20)
fig_res_pstr_12A_12P
dev.off()

```

```{r}
#Subset the phyloseq object to contain only the samples and variables you want to explore
pstr_6A_6P <- subset_samples(diel_pstr,  diel_pstr@sam_data$diel_time=='T6A' |
                                             diel_pstr@sam_data$diel_time=='T6P')

ancom_pstr_6A_6P = ancombc2(data = pstr_6A_6P, assay_name = "counts", tax_level = NULL,
                  fix_formula = "diel_time", rand_formula = NULL,
                  p_adj_method = "fdr", pseudo = 0, pseudo_sens = TRUE,
                  prv_cut = 0.01, lib_cut = 0, s0_perc = 0.05,
                  group = "diel_time", struc_zero = TRUE, neg_lb = FALSE,
                  alpha = 0.05, n_cl = 2, verbose = TRUE,
                  global = FALSE, pairwise = TRUE, dunnet = FALSE, trend = FALSE, #Change this when more than 1 factor or time points
                  iter_control = list(tol = 1e-2, max_iter = 20, 
                                      verbose = TRUE),
                  em_control = list(tol = 1e-5, max_iter = 100),
                  lme_control = lme4::lmerControl(),
                  mdfdr_control = list(fwer_ctrl_method = "fdr", B = 100),
                  trend_control = list(contrast = list(matrix(c(1, 0, -1, 1),
                                                              nrow = 2, 
                                                              byrow = TRUE),
                                                       matrix(c(-1, 0, 1, -1),
                                                              nrow = 2, 
                                                              byrow = TRUE)),
                                       node = list(2, 2),
                                       solver = "ECOS",
                                       B = 100))

res_prim_pstr_6A_6P = ancom_pstr_6A_6P$res
res_prim_pstr_6A_6P
df_res_pstr_6A_6P = res_prim_pstr_6A_6P %>% dplyr::filter(diff_diel_timeT6P) %>%
    dplyr::select(taxon, contains("diel_time")) #CHANGE ME TO VARIABLE

df_fig_res_pstr_6A_6P = df_res_pstr_6A_6P %>% 
    arrange(desc(`lfc_diel_timeT6P`
)) %>%
    mutate(direct = ifelse(`lfc_diel_timeT6P`
 > 0, "Positive LFC", "Negative LFC"))


df_fig_res_pstr_6A_6P$taxon = factor(df_fig_res_pstr_6A_6P$taxon, levels = df_fig_res_pstr_6A_6P$taxon)
df_fig_res_pstr_6A_6P$direct = factor(df_fig_res_pstr_6A_6P$direct, 
                           levels = c("Positive LFC", "Negative LFC"))
  
df_fig_res_pstr_6A_6P.df = as.data.frame(df_fig_res_pstr_6A_6P)
write.table(df_fig_res_pstr_6A_6P.df, file = "/path/to/data/curacao/metabarcoding/analysis/18s_diel/ancom/ancom_pstr_6A_6P.tsv")


fig_res_pstr_6A_6P = df_fig_res_pstr_6A_6P %>%
    ggplot(aes(x = taxon, y = `lfc_diel_timeT6P`, fill = `lfc_diel_timeT6P`)) + 
    geom_bar(stat = "identity", width = 0.7, color = "black", 
             position = position_dodge(width = 0.4)) +
    geom_errorbar(aes(ymin = `lfc_diel_timeT6P` - `se_diel_timeT6P`, ymax = `lfc_diel_timeT6P` + `se_diel_timeT6P`), 
                  width = 0.2, position = position_dodge(0.05), color = "black") + 
    labs(x = "Eukaryotic Order", y = "Log fold change", 
         title = "LFC from T6A to T6P", subtitle = "ANCOM-BC derived signficant taxa") + scale_fill_viridis_c(option = "plasma") + scale_color_viridis_c(option = "plasma") +
  theme_bw() + 
  theme(legend.position = "none",
        panel.grid.minor.y = element_blank()) + coord_flip()

fig_res_pstr_6A_6P

pdf("/path/to/data/curacao/metabarcoding/analysis/18s_diel/ancom/ancom_pstr_6A_6P.pdf", width = 13, height = 20)
fig_res_pstr_6A_6P
dev.off()

```


##################################################################################
##################################################################################
###                          Heatmaps w/ AMPVIS2                               ###
##################################################################################
##################################################################################

##################################################################################
###                                    PSTR                                    ###
##################################################################################

#PSTR (Samples through time, D1-D2-D3) **W/O SYMBIODINIACEAE**
```{r}
library(ampvis2)

ampvis2_pstr<- amp_load(diel_pstr)



av2_pstr<- amp_heatmap(ampvis2_pstr, 
                       order_x_by = dielpstrdayorder, 
                       group_by = "sample_name", 
                       #facet_by = "diel_time",
                       tax_add = c("Class","Family","Genus"), 
                       tax_aggregate = "OTU", 
                       plot_values = FALSE,
                       tax_show = 25, 
                       color_vector = c("snow", "steelblue")) + 
                        theme_classic() + 
                        theme(axis.text.x = element_text(angle = 45, hjust = 1))

av2_pstr

pdf("/path/to/data/curacao/metabarcoding/analysis/18s_diel/heatmaps/pstr_hm_samplebytimepoint_clean.pdf", width = 14, height = 6)
av2_pstr
dev.off()
```

#PSTR (Samples through time, D1-D2-D3) **W/O SYMBIODINIACEAE**
```{r}
library(ampvis2)

ampvis2_pstr<- amp_load(diel_pstr)

av2_pstr<- amp_heatmap(ampvis2_pstr, 
                       order_x_by = dielpstrorder, 
                       group_by = "sample_name", 
                       tax_add = c("Class","Family","Genus"), 
                       tax_aggregate = "OTU", 
                       tax_show = 25, 
                       plot_values = FALSE,
                       color_vector = c("snow", "steelblue")) + 
                        theme_classic() + 
                        theme(axis.text.x = element_text(angle = 45, hjust = 1))

av2_pstr

pdf("/path/to/data/curacao/metabarcoding/analysis/18s_diel/heatmaps/pstr_hm_samplebyday.pdf", width = 14, height = 6)
av2_pstr
dev.off()
```

#PSTR (Samples through time, D1-D2-D3) **SYMBIODINIACEAE ONLY**
```{r}
library(ampvis2)

ampvis2_pstr<- amp_load(dielsymb_pstr)

av2_pstr<- amp_heatmap(ampvis2_pstr, 
                       order_x_by = dielpstrdayorder, 
                       group_by = "sample_name", 
                       #facet_by = "diel_time",
                       tax_add = c("Class","Family","Genus"), 
                       tax_aggregate = "OTU", 
                       plot_values = FALSE,
                       tax_show = 25, 
                       color_vector = c("snow", "steelblue")) + 
                        theme_classic() + 
                        theme(axis.text.x = element_text(angle = 45, hjust = 1))

av2_pstr

pdf("/path/to/data/curacao/metabarcoding/analysis/18s_diel/heatmaps/pstr_symb_hm_samplebytimepoint_clean.pdf", width = 14, height = 5.75)
av2_pstr
dev.off()
```

#PSTR (Samples through time, D1-D2-D3) **SYMBIODINIACEAE ONLY**
```{r}
library(ampvis2)

ampvis2_pstr<- amp_load(dielsymb_pstr)

av2_pstr<- amp_heatmap(ampvis2_pstr, 
                       order_x_by = dielpstrorder, 
                       group_by = "sample_name", 
                       tax_add = c("Class", "Order", "Genus", "Species"), 
                       tax_aggregate = "OTU", 
                       tax_show = 25, 
                       plot_values = FALSE,
                       color_vector = c("snow", "steelblue")) + 
                        theme_classic() + 
                        theme(axis.text.x = element_text(angle = 45, hjust = 1))

av2_pstr

pdf("/path/to/data/curacao/metabarcoding/analysis/18s_diel/heatmaps/pstr_symb_hm_samplebyday.pdf", width = 14, height = 6)
av2_pstr
dev.off()
```



##################################################################################
##################################################################################
###                          CORE ASVs w/ AMPVIS2                              ###
##################################################################################
##################################################################################

#amp_venn: Venn diagram of core OTUs

##################################################################################
###                                    PSTR                                    ###
##################################################################################

#PSTR (Samples through time, D1-D2-D3) **W/O SYMBIODINIACEAE**
```{r}
library(ampvis2)

ampvis2_pstr<- amp_load(diel_pstr)

avenn_pstr<- amp_venn(ampvis2_pstr, 
                       group_by = "day_night", 
                       cut_a = 0.1,
                       cut_f = 80, 
                       text_size = 5, 
                       detailed_output = FALSE,
                       normalise = TRUE) + 
                       theme_classic() + 
                       scale_colour_manual(values=c("midnightblue","goldenrod1"))

avenn_pstr

pdf("/path/to/data/curacao/metabarcoding/analysis/18s_diel/heatmaps/pstr_avenn_samplename.pdf", width = 18, height = 13)
avenn_pstr
dev.off()
```




##################################################################################
##################################################################################
###                               Core Microbiome                              ###
##################################################################################
##################################################################################

##################################################################################
###                       Shared Core w/ Venn Example                          ###
##################################################################################
#From Shetty and Lahti et al. https:/microbiome.github.io/tutorials/core_venn.html

```{r}
#install.packages("eulerr") # If not installed
library(eulerr)
library(microbiome)
#devtools::install_github('microsud/microbiomeutilities')
library(microbiomeutilities)
```

#We will aim to identify shared core taxa between nationalities.
```{r}
# simple way to count number of samples in each group
table(meta(diel_pstr)$diel_time, useNA = "always")
```

# convert to relative abundances
```{r}
diel_pstr.rel <- microbiome::transform(diel_pstr, "compositional")
```

#Make a list from variable
```{r}
time_points <- unique(as.character(meta(diel_pstr.rel)$diel_time))
print(time_points)
```

#Write a for loop to go through each of the time points one by one and combine identified core taxa into a list.
```{r}
list_core <- c() # an empty object to store information

for (n in time_points){ # for each variable n in DiseaseState
    #print(paste0("Identifying Core Taxa for ", n))
    
    diel_pstr.sub <- subset_samples(diel_pstr.rel, time_points == n) # Choose sample from diel time by n
    
    diel_pstr_core_m <- core_members(diel_pstr.sub, # ps.sub is phyloseq selected with only samples from g 
                           detection = 0.001, # 0.001 in atleast 90% samples 
                           prevalence = 0.75)
    print(paste0("No. of core taxa in ", n, " : ", length(diel_pstr_core_m))) # print core taxa identified in each DiseaseState.
    list_core[[n]] <- diel_pstr_core_m # add to a list core taxa for each group.
    #print(list_core)
}
```

```{r}
print(list_core)
```

```{r}
# Specify colors and plot venn
# supplying colors in the order they appear in list_core
mycols <- c(T12A="mediumpurple", T6A="#d6e2e9", T12P="#fcf5c7", T6P="lightgoldenrod") 
plot(venn(list_core),
     fills = mycols)
```

#Here, we see that the ids are only names without taxonomic information. This is because the rownames of otu_table and tax_table are usually IDs or sequences.
#The format_to_besthit() function in microbiomeutilites can be useful which add best taxonomic information that is available as demonstrated below.
```{r}
print(list_core)

# use the pseq.rel object created at the begening of this tutorial. 
taxa_names(diel_pstr.rel)[1:5]
```

#DOES NOT WORK BECAUSE 18S!!
```{r}
# format names
diel_pstr.rel.f <- format_to_besthit(diel_pstr.rel)
# check names
taxa_names(diel_pstr.rel.f)[1:5]

```
#Note: There are limitations to the number of groups that can be plotted with the eulerr::venn(). Check eulerr documentation for more detailed information.

##################################################################################
###                               Core Venn Diagram                            ###
##################################################################################

```{r}
#install.packages("ggvenn")
library(ggvenn)

#diel_pstr_core_otu <- diel_pstr_core_members@otu_table %>% group_by(diel_pstr_core_members@sam_data$diel_time) %>% as.data.frame()

listcore <- list_core
listcore <- listcore[c("T12A","T6A", "T12P","T6P")]

venn_diel_pstr <- ggvenn(listcore,
                         columns = NULL,
                         show_elements = FALSE,
                         show_percentage = FALSE,
                         digits = 1,
                         fill_color = c("midnightblue","slategray","gold", "orange"),
                         fill_alpha = 0.5,
                         stroke_color = "black",
                         stroke_alpha = 1,
                         stroke_size = 1,
                         stroke_linetype = "solid",
                         set_name_color = "black",
                         set_name_size = 6,
                         text_color = "black",
                         text_size = 4,
                         label_sep = ",",
                         count_column = NULL,
                         show_outside = c("auto"),
                         auto_scale = FALSE
                          )
              

pdf("/path/to/data/curacao/metabarcoding/analysis/18s_diel/coreupset/pstr_alltaxa_venn_core75_lefttoright.pdf", width = 9, height = 7)
venn_diel_pstr
dev.off()
```

#produce unqiue values to excel
```{r}
library(dplyr)
T12A_unique <- list_core$T12A
T6A_unique <- list_core$T6A
T12P_unique <- list_core$T12P
T6P_unique <- list_core$T6P

write.csv(T12A_unique, "/path/to/data/curacao/metabarcoding/data/18s_diel/18s_core_asvs_T12A.csv")
write.csv(T6A_unique, "/path/to/data/curacao/metabarcoding/data/18s_diel/18s_core_asvs_T6A.csv")
write.csv(T12P_unique, "/path/to/data/curacao/metabarcoding/data/18s_diel/18s_core_asvs_T12P.csv")
write.csv(T6P_unique, "/path/to/data/curacao/metabarcoding/data/18s_diel/18s_core_asvs_T6P.csv")
```


##################################################################################
###                               Core Upset Plot                              ###
##################################################################################

```{r}
#install.packages("UpSetR")
library(UpSetR)
library(MicrobiotaProcess)

#get data to observe upset - using whole data
upsetda <- get_upset(diel_pstr, factorNames="diel_time")

otuda <- t(diel_pstr@otu_table) %>% as.data.frame

sampleda <- map["diel_time"]

head(sampleda)

upsetda2 <- get_upset(obj=otuda, sampleda=sampleda, 
                     factorNames="diel_time")

#Do Not Touch
pstr_upsetr <- UpSetR::upset(upsetda, 
                     sets=c("T6P","T12P","T6A","T12A"), 
                     sets.bar.color = c("orange","gold","slategray","midnightblue"),
                     order.by = "freq", 
                     empty.intersections = "on", 
                     keep.order = TRUE,
                     mainbar.y.label = "ASV Intersection Size"
                     )

pdf("/path/to/data/curacao/metabarcoding/analysis/18s_diel/coreupset/pstr_upset_dielpstr_freq.pdf", width = 9, height = 5)
pstr_upsetr
dev.off()


#make upset from list of core members
library(UpSetR)

pstr_upsetr_core <- UpSetR::upset(fromList(listcore[c("T6P","T12P","T6A","T12A")]), 
                     sets=c("T6P","T12P","T6A","T12A"), 
                     sets.bar.color = c("orange","gold","slategray","midnightblue"),
                     order.by = "freq", 
                     empty.intersections = "on", 
                     keep.order = TRUE,
                     mainbar.y.label = "ASV Intersection Size"
                     )

pdf("/path/to/data/curacao/metabarcoding/analysis/18s_diel/coreupset/pstr_nosymb_upsetcore_clean.pdf", width = 9, height = 5)
pstr_upsetr_core
dev.off()
```

#Overcomplicate the aesthetics **incomplete**
```{r}
library(ComplexUpset)

pstr_upsetr <- upset(listcore, fromList(listcore[c("T12A","T6A","T12P","T6P")]), 
                     sets=c("T12A","T6A","T12P","T6P"), 
                     #sets.bar.color = c("orange","midnightblue","gold","slategray"),
                     order.by = "degree", 
                     #empty.intersections = "on", 
                     keep.order = TRUE,
                     mainbar.y.label = "ASV Intersection Size",
                     stripes=c("orange","midnightblue","gold","slategray")
                     )

pstr_upsetr <- upset(a,colnames(a),
                     intersections=list(c("one"),c("one","two"),c("one","two","three","four"),c("one","three","four"),c("one","two","three"),c("three"),c("two"),c("four"),c("three","four"),c("two","four")),
                     sort_intersections=FALSE)
```


##################################################################################
##################################################################################
###                                Co-Occurence                                ###
##################################################################################
##################################################################################

#Need PS objects to combine for Networks
```{r}
#ALL TAXA
write.csv(diel_pstr_all@otu_table, "/path/to/data/curacao/metabarcoding/data/16S_18S_Network/18s_all_otus.csv")
write.csv(diel_pstr_all@tax_table, "/path/to/data/curacao/metabarcoding/data/16S_18S_Network/18s_all_tax.csv")

#No Symbiodiniaceae
write.csv(diel_pstr@otu_table, "/path/to/data/curacao/metabarcoding/data/16S_18S_Network/18s_nosymb_otus.csv")
write.csv(diel_pstr@tax_table, "/path/to/data/curacao/metabarcoding/data/16S_18S_Network/18s_nosymb_tax.csv")

#ONLY Symbiodiniaceae
write.csv(diel_pstr@otu_table, "/path/to/data/curacao/metabarcoding/data/16S_18S_Network/18s_symb_otus.csv")
write.csv(dielsymb_pstr@tax_table, "/path/to/data/curacao/metabarcoding/data/16S_18S_Network/18s_symb_tax.csv")


```
